module.exports = function (uname, pwd, realm, host, verboseLevel) {
	const pve_utils = require("./pve-curl")(verboseLevel);

	const logging = require("./utils/logging")(verboseLevel);

	var pveAuthInfo = {
		apiToken: null,
		username: `${uname}@${realm}`,
		password: pwd,
		realm: realm,
		host: host,
		endpoint: `https://${host}:8006/api2/json`,

		apiTicket: {
			ticket: "",
			csrfPreventionToken: "",
			timeStamp: 0
		}
	};

	// `standaloneFlag` tells whether the ticket is generated by the main module(`pve-api.js`)[$standaloneFlag=false]
	// or by the standalone module(`pve-storage/api.js`)[$standaloneFlag=true]
	// Default is $standaloneFlag=true
	var standaloneFlag = true;

	let _GenerateNewTicket = async () => {
		if (standaloneFlag) {
			if (pveAuthInfo.apiTicket.timeStamp + 7200 < new Date().getTime()) {
				var response = await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/ticket`,
					{
						username: pveAuthInfo.username,
						password: pveAuthInfo.password,
					},
					"",
					""
				);
				var resBody = null;

				if (response.body !== "undefined" && response.body !== null) {
					var body = response.body;
					if (typeof body === "string") {
						resBody = JSON.parse(body);
					} else {
						resBody = body;
					}
				}
				var ticketData = resBody.data;
				pveAuthInfo.apiTicket.csrfPreventionToken = ticketData.CSRFPreventionToken;
				pveAuthInfo.apiTicket.ticket = ticketData.ticket;
				pveAuthInfo.apiTicket.timeStamp = new Date().getTime();
				logging.Info(`New ticket generated. Next ticket generation in ${7200 - (-1 * Math.floor((pveAuthInfo.apiTicket.timeStamp + 7200 - new Date().getTime()) / 1000))}`);
			}
		}
	};

	let Module = {
		/**
		 * @access private
		 * @param {object} ticket
		 * @description Sets the ticket to be used to make request to the API.
		 *
		 *              __Used only by module `pve-api.js`.__
		 *
		 *              __Use of this function is highly discouraged!__
		 */
		_SetTicket: function (ticket) {
			pveAuthInfo.apiTicket.csrfPreventionToken = ticket.csrfPreventionToken;
			pveAuthInfo.apiTicket.ticket = ticket.ticket;
			pveAuthInfo.apiTicket.timeStamp = ticket.timeStamp;
			standaloneFlag = false;
		},

		SetSslVerifyPeer: (sslVerifyPeer) => {
			logging.Info(`SSL Verify Peer set to ${sslVerifyPeer}`);
			pve_utils.PveCurl.SetSslVerifyPeer(sslVerifyPeer);
		},

		SetSslVerifyHost: (sslVerifyHost) => {
			logging.Info(`SSL Verify Host set to ${sslVerifyHost}`);
			pve_utils.PveCurl.SetSslVerifyHost(sslVerifyHost);
		},

		Get: async function () {
			await _GenerateNewTicket();
			return await pve_utils.PveCurl.Get(
				`${pveAuthInfo.endpoint}/access`,
				{},
				{},
				{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
			);
		},

		Domains: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/domains`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/domains`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			Realm: function (realm) {
				return {
					Get: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Get(
							`${pveAuthInfo.endpoint}/access/domains/${realm}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Put: async function (params) {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Put(
							`${pveAuthInfo.endpoint}/access/domains/${realm}`,
							params,
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Delete: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Delete(
							`${pveAuthInfo.endpoint}/access/domains/${realm}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Sync: {
						Post: async function (params) {
							await _GenerateNewTicket();
							return await pve_utils.PveCurl.Post(
								`${pveAuthInfo.endpoint}/access/domains/${realm}/sync`,
								params,
								{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
								{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
							);
						},
					},
				};
			},
		},

		Groups: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/groups`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/groups`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			GroupID: function (groupid) {
				return {
					Get: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Get(
							`${pveAuthInfo.endpoint}/access/groups/${groupid}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Put: async function (params) {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Put(
							`${pveAuthInfo.endpoint}/access/groups/${groupid}`,
							params,
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Delete: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Delete(
							`${pveAuthInfo.endpoint}/access/groups/${groupid}`,
							{},
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},
				};
			},
		},

		OpenID: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/openid`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
			AuthUrl: {
				Post: async function (params) {
					await _GenerateNewTicket();
					await pve_utils.PveCurl.Post(
						`${pveAuthInfo.endpoint}/access/openid/auth-url`,
						params,
						{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
						{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
					);
				},
			},
			Login: {
				Post: async function (params) {
					await _GenerateNewTicket();
					await pve_utils.PveCurl.Post(
						`${pveAuthInfo.endpoint}/access/openid/login`,
						params,
						{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
						{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
					);
				},
			},
		},

		Roles: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/roles`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/roles`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			RoleID: function (roleid) {
				return {
					Get: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Get(
							`${pveAuthInfo.endpoint}/access/roles/${roleid}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},
					Put: async function (params) {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Put(
							`${pveAuthInfo.endpoint}/access/roles/${roleid}`,
							params,
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},
					Delete: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Delete(
							`${pveAuthInfo.endpoint}/access/roles/${roleid}`,
							{},
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},
				};
			},
		},

		Tfa: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/tfa`,
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/tfa`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			UserID: function (userid) {
				return {
					Get: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Get(
							`${pveAuthInfo.endpoint}/access/tfa/${userid}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Post: async function (params) {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Post(
							`${pveAuthInfo.endpoint}/access/tfa/${userid}`,
							params,
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Id: function (id) {
						return {
							Get: async function () {
								await _GenerateNewTicket();
								return await pve_utils.PveCurl.Get(
									`${pveAuthInfo.endpoint}/access/tfa/${userid}/${id}`,
									{},
									{},
									{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
								);
							},

							Put: async function (params) {
								await _GenerateNewTicket();
								return await pve_utils.PveCurl.Put(
									`${pveAuthInfo.endpoint}/access/tfa/${userid}/${id}`,
									params,
									{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
									{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
								);
							},

							Delete: async function (params) {
								await _GenerateNewTicket();
								return await pve_utils.PveCurl.Delete(
									`${pveAuthInfo.endpoint}/access/tfa/${userid}/${id}`,
									params,
									{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
									{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
								);
							},
						};
					},
				};
			},
		},

		Users: {
			Get: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/users`,
					params,
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/users`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},

			UserID: function (userid) {
				return {
					Get: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Get(
							`${pveAuthInfo.endpoint}/access/users/${userid}`,
							{},
							{},
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Put: async function (params) {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Put(
							`${pveAuthInfo.endpoint}/access/users/${userid}`,
							params,
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Delete: async function () {
						await _GenerateNewTicket();
						return await pve_utils.PveCurl.Delete(
							`${pveAuthInfo.endpoint}/access/users/${userid}`,
							{},
							{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
							{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
						);
					},

					Token: {
						Get: async function () {
							await _GenerateNewTicket();
							return await pve_utils.PveCurl.Get(
								`${pveAuthInfo.endpoint}/access/users/${userid}/token`,
								{},
								{},
								{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
							);
						},

						TokenID: function (tokenid) {
							return {
								Get: async function () {
									await _GenerateNewTicket();
									return await pve_utils.PveCurl.Get(
										`${pveAuthInfo.endpoint}/access/users/${userid}/token/${tokenid}`,
										{},
										{},
										{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
									);
								},

								Post: async function (params) {
									await _GenerateNewTicket();
									return await pve_utils.PveCurl.Post(
										`${pveAuthInfo.endpoint}/access/users/${userid}/token/${tokenid}`,
										params,
										{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
										{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
									);
								},

								Put: async function (params) {
									await _GenerateNewTicket();
									return await pve_utils.PveCurl.Put(
										`${pveAuthInfo.endpoint}/access/users/${userid}/token/${tokenid}`,
										params,
										{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
										{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
									);
								},

								Delete: async function () {
									await _GenerateNewTicket();
									return await pve_utils.PveCurl.Delete(
										`${pveAuthInfo.endpoint}/access/users/${userid}/token/${tokenid}`,
										{},
										{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
										{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
									);
								},
							};
						},
					},

					Tfa: {
						Get: async function (params) {
							await _GenerateNewTicket();
							return await pve_utils.PveCurl.Delete(
								`${pveAuthInfo.endpoint}/access/users/${userid}/tfa`,
								params,
								{},
								{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
							);
						},
					},
				};
			},
		},

		Acl: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/acl`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
			Put: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Put(
					`${pveAuthInfo.endpoint}/access/acl`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
		},
		Password: {
			Put: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Put(
					`${pveAuthInfo.endpoint}/access/password`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
		},
		Permissions: {
			Get: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/permissions`,
					params,
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
		},
		Ticket: {
			Get: async function () {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Get(
					`${pveAuthInfo.endpoint}/access/ticket`,
					{},
					{},
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
			Post: async function (params) {
				await _GenerateNewTicket();
				return await pve_utils.PveCurl.Post(
					`${pveAuthInfo.endpoint}/access/ticket`,
					params,
					{ CSRFPreventionToken: pveAuthInfo.apiTicket.csrfPreventionToken },
					{ PVEAuthCookie: pveAuthInfo.apiTicket.ticket }
				);
			},
		},
	};

	return Module;
};